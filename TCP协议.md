TCP特点：
1. 面向字节流，面向连接的双工通信，能够提供可靠的服务。
2. TCP的每一条连接都是点对点。

TCP前面有10个必选项和后面1个可选项；报头最短20个字节（不包含可选项）；最长60个字节（包含可选项）。

- [TCP报头段](#TCP报头段)
- [TCP数据段](#TCP数据段)
- [TCP协议分析](#TCP协议分析)
- [TCP协议实现](#TCP协议实现)

## TCP报头段

TCP头格式的直观图如下图所示：

![TCP头格式](img/TCP头格式.png)

10个必选项分别为：
1. source port：16位

2. destination port：16位

3. Sequence Number：32位，解决网络中乱序，主机会按Seq号拼接数据。
> SYN=0时，Seq表示数据区第一个字节的序号<br>
> SYN=1时，Seq表示初始发送的字号<br>

4. Acknowledgement Number：32位，期望对方发来报文段的Seq是多少，因此Ack应当是对方上次发来的Seq+1。

5. offset：4位，表示报头长度，单位是4byte。

6. reserverd：4位，保留位。

7. TCP Flag：8位，表明本次报文功能
> CWR：压缩，0X80<br>
> ECE：拥塞，0X40<br>
> URG：紧急，0X20 —— 表明Urgent Pointer有效，系统需尽快发送<br>
> ACK：确认，0X10 —— 除挥手/握手时使用，建立连接后所有传达的报文段ACK set 1<br>
> PSH：推送，0X08 —— 用于client/server端的两个应用程序即时响应。发送方PSH set 1，立刻创建报文段发出去，接收方收到PSH set 1的报文段，直接交付应用程序，而不是缓存满再向上交付<br>
> RST：复位，0X04 —— 复位相应的TCP连接<br>
> SYN：同步，0X02 —— 握手时有效<br>
> FIN：终止，0X01 —— 挥手时有效<br>

8. Window：16位，流量控制，告诉对方可发数据的最大字节数，即本机接收窗口，TCP中的窗口扩大因子可增加窗口大小。

9. Checksum：16位，校验报头和数据。
> 发送端计算，接收端验证。如果传输过程中TCP头和数据段发生改变，则校验和的数值出现差错，接收端放弃TCP段。<br>
> TCP必须有校验和，UDP可选校验和；TCP/UDP计算校验和时必须加一个12字节的伪首部。<br>
> <br>
> TCP/UDP伪首部包含4byte源IP地址，4byte目的IP地址，1Byte填充0，1Byte填充协议，2Byte TCP/UDP长度。<br>
> 伪首部是一个虚拟的数据结构，既不向上（应用层），也不向下（网络层）传输，仅用作计算Checksum的数值，

10. Urgent Pointer：报文段中紧急数据的字节数。
> Window = 0时也能发送紧急数据。

可选项：TCP option
> 包含时间戳、窗口扩大因子等选项。

## TCP数据段

数据段封装上层应用层中的数据，在TCP（传输层）中加上TCP头传入IP层

## TCP协议分析

### ISN初始化

客户端和服务端之间的连接通过双方ip/port组成的四元组加上seq来保持，如果每次使用相同的seq，可能会被猜到而产生恶意攻击。

因此ISN的产生使用随机的方法。

### 三次握手

三次握手是为了防止因网络问题造成的服务端无法知晓客户端是否接收到第二次握手的报文。

SYN信号在第一次和第二次握手中发送。

### 四次挥手

四次挥手是为了给客户端/服务端清理数据的时间。

FIN信号在第一次和第三次回收中发送。

第四次握手发出后，客户端等待2MSL时间。
> 当服务端未收到ACK报文时，会重发FIN请求（即重复第三次挥手），2MSL就是为了防止丢包服务端无法收到ACK报而set的定时器。

